worker_processes auto;

events {
  worker_connections 1024;
}

http {
  upstream control_plane {
    server control:8080;
  }

  upstream livekit_signal {
    server livekit:7880;
  }

  server {
    listen 80;
    server_name _;

    client_max_body_size 1m;

    location /health {
      proxy_pass http://control_plane/health;
    }

    location /ready {
      proxy_pass http://control_plane/ready;
    }

    location /sessions {
      proxy_pass http://control_plane/sessions;
    }

    location /policy/poses {
      proxy_pass http://control_plane/policy/poses;
    }

    location /policy-socket {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_pass http://control_plane/policy-socket;
    }

    location /livekit/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_pass http://livekit_signal/;
    }
  }
}
